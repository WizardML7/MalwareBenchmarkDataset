import os
import requests
import time
from pathlib import Path

def upload_files(file_paths, upload_url, cookies=None):
    files = [(os.path.basename(file_path), open(file_path, 'rb')) for file_path in file_paths]
    data = {'script': "ember_docker_script.sh"}

    start_time = time.time()
    response = requests.post(upload_url, files=files, data=data, cookies=cookies)
    end_time = time.time()

    print(f"Request duration: {end_time - start_time:.2f} seconds")

    if response.status_code == 200:
        print("Upload successful!")
        print(response.text)
    else:
        print(f"Upload failed with status code {response.status_code}")
        print(response.text)

def upload_directory(directory_path, upload_url, cookies=None):
    file_paths = [str(file_path) for file_path in Path(directory_path).rglob('*') if file_path.is_file()]

    upload_files(file_paths, upload_url, cookies=cookies)

def upload_samples(directory_path, upload_url, n_samples, cookies=None):
    file_paths = [str(file_path) for file_path in Path(directory_path).rglob('*') if file_path.is_file()]

    selected_files = file_paths[:n_samples]

    upload_files(selected_files, upload_url, cookies=cookies)

def login_and_get_session(base_url, email, password):
    login_url = f"{base_url}/login"
    login_data = {'email': email, 'password': password}
    
    response = requests.post(login_url, data=login_data)
    
    # Debugging output
    print("Login response status code:", response.status_code)
    print("Response text:", response.text)
    
    if response.ok:
        session_cookie = response.cookies.get('session')
        if session_cookie:
            print("Session cookie retrieved successfully.")
            return response.cookies
        else:
            print("Session cookie not found in response.")
            return None
    else:
        print("Login failed with status code:", response.status_code)
        return None

def main():
    base_url = 'http://127.0.0.1:5000'
    directory_path = os.path.expanduser('~/WorkArea/samples')
    upload_url = f"{base_url}/upload"
    email = 'dml3483@rit.edu'
    password = os.getenv('A_PASSWORD')
    print(password)
    
    cookies = login_and_get_session(base_url, email, password)
    
    if cookies:
        # Upload all files
        # upload_directory(directory_path, upload_url, cookies=cookies)

        # Upload a specific number of samples
        n_samples = 5  # Replace with the number of samples you want to upload
        upload_samples(directory_path, upload_url, n_samples, cookies=cookies)
    else:
        print("Unable to get session cookie.")

if __name__ == "__main__":
    main()

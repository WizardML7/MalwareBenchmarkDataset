import os
import requests
import time
from pathlib import Path

def upload_files(file_paths, upload_url, cookies=None):
    # Prepare files for upload
    files = [(os.path.basename(file_path), open(file_path, 'rb')) for file_path in file_paths]

    # Measure time for the upload request
    start_time = time.time()
    response = requests.post(upload_url, files=files, cookies=cookies)
    end_time = time.time()

    print(f"Request duration: {end_time - start_time:.2f} seconds")

    # Handle response
    if response.status_code == 200:
        print("Upload successful!")
        print(response.text)  # or handle the response data as needed
    else:
        print(f"Upload failed with status code {response.status_code}")
        print(response.text)  # or handle the error message as needed

def upload_directory(directory_path, upload_url, cookies=None):
    # Collect all file paths in the directory
    file_paths = [str(file_path) for file_path in Path(directory_path).rglob('*') if file_path.is_file()]

    # Upload all files
    upload_files(file_paths, upload_url, cookies=cookies)

def upload_samples(directory_path, upload_url, n_samples, cookies=None):
    # Collect all file paths in the directory
    file_paths = [str(file_path) for file_path in Path(directory_path).rglob('*') if file_path.is_file()]

    # Select the specified number of samples
    selected_files = file_paths[:n_samples]

    # Upload selected samples
    upload_files(selected_files, upload_url, cookies=cookies)

def login_and_get_session(base_url, username, password):
    login_url = f"{base_url}/login"
    login_data = {'username': username, 'password': password}
    
    response = requests.post(login_url, data=login_data)
    
    if response.ok:
        # Assuming the session cookie is set in the response cookies
        session_cookie = response.cookies.get('session')
        return {'session': session_cookie}
    else:
        print("Login failed!")
        return None

def main():
    base_url = 'http://127.0.0.1:5000'  # Replace with your server URL
    directory_path = os.path.expanduser('~/WorkArea/samples')  # Replace with your directory path
    upload_url = f"{base_url}/upload"  # Replace with your actual upload URL
    username = 'your_username'  # Replace with your username
    password = 'your_password'  # Replace with your password
    
    # Get the session cookie
    cookies = login_and_get_session(base_url, username, password)
    
    if cookies:
        # Uncomment one of the following lines based on your requirement
        # Upload all files
        # upload_directory(directory_path, upload_url, cookies=cookies)

        # Upload a specific number of samples
        n_samples = 5  # Replace with the number of samples you want to upload
        upload_samples(directory_path, upload_url, n_samples, cookies=cookies)
    else:
        print("Unable to get session cookie.")

if __name__ == "__main__":
    main()

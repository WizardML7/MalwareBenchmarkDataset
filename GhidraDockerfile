FROM ubuntu:18.04

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV VERSION 11.1.2_PUBLIC
ENV GHIDRA_SHA 219ec130b901645779948feeb7cc86f131dd2da6c36284cf538c3a7f3d44b588
ENV GHIDRA_URL https://github.com/NationalSecurityAgency/ghidra/releases/download/Ghidra_11.1.2_build/ghidra_11.1.2_PUBLIC_20240709.zip
ENV GHIDRA_PATH /ghidra

# Install required packages
RUN apt-get update && apt-get install -y \
    python2.7 \
    python2.7-dev \
    python-pip \
    openjdk-11-jdk \
    wget \
    unzip \
    bash \
    curl \
    && apt-get clean

# Install Python packages
RUN python2.7 -m pip install networkx

# Download and extract Ghidra
RUN curl -L "https://github.com/NationalSecurityAgency/ghidra/releases/download/Ghidra_11.1.2_build/ghidra_11.1.2_PUBLIC_20240709.zip" -o /tmp/ghidra.zip && \
    echo "${GHIDRA_SHA} /tmp/ghidra.zip" | sha256sum -c - && \
    unzip /tmp/ghidra.zip -d / && \
    mv /ghidra_${VERSION} ${GHIDRA_PATH} && \
    chmod +x ${GHIDRA_PATH}/ghidraRun && \
    echo "===> Clean up unnecessary files..." && \
    apt-get purge -y --auto-remove && \
    rm -rf /var/lib/apt/lists/* /var/cache/apt/archives /tmp/* /var/tmp/* /ghidra/docs /ghidra/Extensions/Eclipse /ghidra/licenses

# Build Ghidra natives
RUN ${GHIDRA_PATH}/support/buildNatives

# Create the working directory
RUN mkdir -p /home/app
WORKDIR /home/app

# Copy scripts to the container
COPY fromsnippets.py /home/app/
COPY process_malware.sh /home/app/
COPY runGhidra.sh /home/app/

# Make the scripts executable
RUN chmod +x /home/app/process_malware.sh /home/app/runGhidra.sh

# Set the entrypoint to keep the container running
CMD ["sleep", "infinity"]
